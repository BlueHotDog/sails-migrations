_ = require('lodash')
fs = require('fs')
wrench = require('wrench')
path = require('path')

DEFAULT_CONFIG_DIR = './grunt/config'
DEFAULT_TASKS_DIR = './grunt/tasks'

class Gake
  # returns a file name without the extension, given a relative filename and a root directory,
  # useful for object mapping
  fileNameFromPath = (fileWithPath, basePath)->
    #getting the file with the extension
    fileWithExtension = path.relative(basePath, fileWithPath).split(path.sep).pop()
    #removing the extension
    path.basename(fileWithExtension, path.extname(fileWithPath))

  constructor: (@grunt) ->

  use: ->
    @loadConfig(@grunt)
    @loadTasks(@grunt)
    @

  # loads grunt configuration from a specified directory
  # arguments:
  #  grunt - a grunt instance
  #  options -
  loadConfig: (grunt) ->
    configDir = grunt.option('configDir') || DEFAULT_CONFIG_DIR
    grunt.file.expand([path.join(configDir, "/**/*.{coffee,js}")])
    .forEach((configFile)->
        configFilePath = path.dirname(configFile)
        res = path.relative(configDir, configFilePath).split(path.sep).reduce((previousValue, currentValue, index, array) ->
          unless (grunt.util._.isString(previousValue) || grunt.util._.isString(previousValue[currentValue]))
            previousValue[currentValue] = previousValue[currentValue] || {}
            previousValue[currentValue]
        , grunt.config.data)
        file = fileNameFromPath(configFile, configDir)
        res[file] = require(path.resolve(configFile))
      )
    grunt.config.data

  loadTasks: (grunt)->
    taskDir = grunt.option('taskDir') || DEFAULT_TASKS_DIR
    unless grunt.file.exists(taskDir)
      return grunt.log.error('Tasks directory "' + taskDir + '" not found.');

    grunt.loadTasks(taskDir)
    wrench.readdirSyncRecursive(taskDir)
    .map((dir) ->
        path.resolve(taskDir, dir))
    .filter((file)->
        fs.statSync(file).isDirectory())
    .forEach((fullPathDir)->
        grunt.loadTasks(fullPathDir))

module.exports = Gake